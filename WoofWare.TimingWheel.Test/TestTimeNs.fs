namespace WoofWare.TimingWheel.Test

open NUnit.Framework
open WoofWare.TimingWheel

[<TestFixture>]
module TestTimeNs =

    let nextMultipleTests =
        [
            true, 71, 1666750235549516973L
            true, 4398, 1232807081547132235L
            false, 702561, 1233263206897519979L
            true, 65, 1813146216102385742L
            false, 3376, 1430224273339105389L
            true, 25, 1289744875932860592L
            true, 2640, 1289026286379471964L
            true, 7062861, 1582734990009845838L
            false, 26123810, 1509919129138733390L
            false, 1076, 1514456253942665045L
            false, 47873597, 1567592770350241609L
            true, 147, 1794365064173405211L
            true, 37416, 1703355717287748172L
            false, 11, 1627963384978464309L
            true, 362857, 1477941666514490237L
            true, 74, 1835379421104268809L
            false, 95, 1518869409078948499L
            false, 152, 1774086601023993329L
            true, 2963474, 1177784542849146405L
            false, 30, 1322037015396216447L
            true, 25, 1686952462277171285L
            false, 77747994, 1232530693599997021L
            true, 39, 1418422346766901525L
            true, 20, 1164906391254697606L
            false, 492686918, 1350478871564364650L
            false, 5626939, 1254841457643911520L
            true, 1189147, 1566503665916540724L
            false, 97968678, 1202922821174442071L
            false, 20, 1241457243504201837L
            true, 99, 1063228554057138547L
            true, 73, 1127965283765790199L
            true, 92513, 1423525486630794877L
            true, 208946207, 1512896538257529954L
            true, 558, 1304902428047905868L
            true, 27, 1454760325484042946L
            true, 9511417, 1224625971869008380L
            true, 1112121, 1486628785456556405L
            true, 36, 1226843097592112449L
            true, 60, 1299700152825201828L
            true, 114032, 1507179377240642938L
            true, 27905, 1379112115218849615L
            true, 368860702, 1318925554630500136L
            true, 1636, 1670399627434728314L
            false, 27, 1735798120119522136L
            true, 14, 1880325938102084694L
            true, 155, 1488215974636830525L
            true, 14319914, 1298824542911254370L
            true, 94, 1961333441294309841L
            true, 321, 1191344461619096942L
            true, 706626, 1179098309603309142L
            true, 5, 1180517413083401326L
            false, 30523434, 1471069600394063742L
            false, 106875447, 1789919428848820069L
            true, 28, 1013606888178097611L
            true, 5178, 1168893256723816286L
            true, 146907740, 1402240657577530746L
            true, 127125596, 1332881548503325287L
            true, 46691, 1526532096462597222L
            true, 1603, 1745157292595832416L
            true, 141650492, 1779813912846436672L
            false, 20, 1916060142837991511L
            false, 27, 1366845916494697310L
            true, 61, 1572832513125636690L
            false, 11254, 1301465801253970270L
            true, 2817556, 1220217790200673585L
            true, 46399240, 1371834303096963699L
            true, 10280275, 1199022106578060117L
            true, 163667, 1277585249492511350L
            true, 441771131, 1865810978398941565L
            true, 22561070, 1535418639166874210L
            true, 677456, 1356038574036607058L
            true, 109, 1102385187927169659L
            true, 169, 1592923082707947954L
            false, 2150725, 1769663126416348286L
            true, 159, 1051696934142612937L
            true, 29, 1844613926625333568L
            true, 30, 1361000119652263049L
            false, 21058, 1323116357214603127L
            true, 1163794, 1221604356987291502L
            false, 30, 1040042732593079852L
            false, 106, 1997585750801910583L
            true, 78, 1292467707712256145L
            false, 882992, 1557796972319309155L
            false, 1821, 1973683565069601822L
            false, 34661, 1737515124214074993L
            true, 91661, 1525765679206225703L
            false, 55, 1287656410542943084L
            true, 25, 1144756873630117512L
            true, 121625, 1374589039260879728L
            false, 55, 1970197704905173942L
            true, 17, 1013158341065700634L
            true, 5176, 1352936504880492660L
            true, 12, 1955810895023292883L
            true, 67034967, 1556142079069258330L
            true, 690258, 1241013338154557567L
            false, 5606142, 1356689387566170970L
            true, 548, 1613807159903275820L
            true, 13, 1425941806049471918L
            false, 155572024, 1398827221896378979L
            true, 938925403, 1550277848520025471L
            false, 13058335, 1306567871862304618L
            true, 2, 1997152439817382933L
            true, 131456077, 1809241097498435420L
            true, 5, 1531223674910420761L
            false, 1125, 1175905228832358761L
            true, 350, 1573261556955534963L
            false, 21, 1529314545697532312L
            false, 11816, 1222083468556908088L
            true, 86085, 1436391155125371248L
            true, 75063667, 1395675403046737786L
            false, 67, 1765632860861960357L
            false, 184086, 1232986716459688821L
            true, 53, 1643034916467763402L
            true, 164, 1931973285029689763L
            true, 10, 1317304422397637720L
            true, 12566, 1421417764422298993L
            true, 122903121, 1389456412090860886L
            false, 3831308, 1617363073756443917L
            true, 2274, 1256309428080267889L
            true, 69, 1975893988922224788L
            true, 460408083, 1956390486383825465L
            true, 20, 1294502403828905377L
            true, 75279, 1210517500455430679L
            false, 335, 1184433858378833746L
            false, 94523, 1420732229891051641L
            false, 16, 1310464979299616987L
            true, 5886, 1602668327390189086L
            false, 9584, 1532134444641007990L
            true, 17, 1362463965931411147L
            false, 2, 1693027090042722358L
            false, 228135731, 1462077890315132778L
            false, 11, 1018644923234572949L
            false, 132723, 1582399817588675962L
            false, 3667, 1506604922540283994L
            true, 265541944, 1695560402922008138L
            true, 310, 1875190738574556027L
            true, 8570918, 1184809728498232683L
            false, 16536379, 1490415593503829866L
            false, 32222516, 1519021258420540539L
            true, 152467451, 1255624172539661165L
            true, 13, 1803425272409148050L
            true, 26, 1021777264383583552L
            true, 11, 1400486869768403422L
            true, 229637, 1410589173350489612L
            true, 32, 1960302290555348647L
            false, 349881185, 1831970413297175407L
            false, 35457345, 1967569813691929674L
            false, 16, 1556051447243676249L
            false, 302933078, 1816140399596962652L
            true, 3609444, 1802393395129668217L
        ]
        |> List.map TestCaseData

    [<TestCaseSource(nameof nextMultipleTests)>]
    let ``Test nextMultiple`` (canEqualAfter : bool, intervalNs : int, afterNs : int64) =
        let base_ = TimeNs.epoch
        let interval = TimeNs.Span.ofInt64Ns (int64<int> intervalNs)
        let after = TimeNs.ofInt64NsSinceEpoch afterNs
        let result = TimeNs.nextMultiple (Some canEqualAfter) base_ after interval

        let lowerBound, upperBound =
            let afterInterval = TimeNs.add after interval

            if canEqualAfter then
                after, TimeNs.sub afterInterval TimeNs.Span.nanosecond
            else
                TimeNs.add after TimeNs.Span.nanosecond, afterInterval

        if result < lowerBound || result > upperBound then
            failwith "result out of bounds"
